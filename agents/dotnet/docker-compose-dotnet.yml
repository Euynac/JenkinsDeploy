services:
  agent-dotnet:
    image: jenkins-agent-dotnet:2.0
    container_name: jenkins-agent-dotnet
    restart: unless-stopped

    environment:
      # Jenkins Master 配置
      JENKINS_URL: "http://jenkins-master:8080"
      JENKINS_AGENT_NAME: "agent-dotnet-8"

      # 重要：需要在 Jenkins Web UI 中创建此 Agent 节点后，复制 Secret 填入这里
      # 步骤：Jenkins > 系统管理 > 节点管理 > 新建节点
      JENKINS_SECRET: "4c104f217ae837f5ce5b250f552e62546e3ed7b3493841fd7454f6856935cd90"

      # Agent 工作目录
      JENKINS_AGENT_WORKDIR: "/home/jenkins/agent"

      # .NET 配置
      DOTNET_CLI_TELEMETRY_OPTOUT: "1"
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"

      # 代理设置：排除内部 Docker 网络和 SonarQube
      NO_PROXY: "localhost,127.0.0.1,jenkins-master,sonarqube,sonarqube-db,172.16.0.0/12,192.168.0.0/16,172.19.0.0/16"
      no_proxy: "localhost,127.0.0.1,jenkins-master,sonarqube,sonarqube-db,172.16.0.0/12,192.168.0.0/16,172.19.0.0/16"

    volumes:
      # 工作目录持久化
      - jenkins-agent-dotnet-workspace:/home/jenkins/agent

      # NuGet 缓存（方案1：主机目录挂载 - 推荐，支持多 agent 共享）
      # 首次启动前需在宿主机执行：
      # mkdir -p /data/jenkins-cache/nuget-packages /data/jenkins-cache/dotnet-tools
      # chown -R 1000:1000 /data/jenkins-cache
      # - /data/jenkins-cache/nuget-packages:/home/jenkins/.nuget/packages
      # - /data/jenkins-cache/dotnet-tools:/home/jenkins/.dotnet/tools

      # NuGet 缓存（方案2：Docker Volume - 当前启用，每个 agent 独立缓存）
      - jenkins-agent-dotnet-nuget:/home/jenkins/.nuget/packages
      - jenkins-agent-dotnet-tools:/home/jenkins/.dotnet/tools

      # 挂载示例项目（Pipeline脚本使用 /test-projects 路径访问）
      - ../../examples:/test-projects:ro

      # Docker-outside-of-Docker: 挂载宿主机 Docker socket
      - /var/run/docker.sock:/var/run/docker.sock

    # 添加 Docker socket 的组 ID，使 jenkins 用户能访问 Docker
    # 注意：这个 GID 需要与宿主机 /var/run/docker.sock 的组 ID 匹配
    group_add:
      - "1001"  # Docker socket GID (可能因系统而异，使用 stat -c '%g' /var/run/docker.sock 查看)

    networks:
      - jenkinsdeploy_default
      - sonarqube-network  # 连接到 SonarQube 网络，用于代码扫描

    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

    labels:
      - "project=jenkins"
      - "type=agent"
      - "language=dotnet"

volumes:
  jenkins-agent-dotnet-workspace:
    driver: local

  # 注意：当前配置使用 Docker Volume（每个agent独立缓存）
  jenkins-agent-dotnet-nuget:
    driver: local
  jenkins-agent-dotnet-tools:
    driver: local

networks:
  jenkinsdeploy_default:
    external: true
  sonarqube-network:
    external: true
    name: sonarqube-network  # 连接到 SonarQube 服务，必须先启动 SonarQube
