version: '3.8'

services:
  jenkins:
    image: jenkins-master-offline:1.0
    container_name: jenkins-master
    restart: unless-stopped

    # 端口映射
    ports:
      - "8080:8080"      # Web UI端口
      - "50000:50000"    # Agent连接端口

    # 数据卷挂载
    volumes:
      # Jenkins主目录（配置、任务、构建历史等）
      - ./jenkins_home:/var/jenkins_home

      # Docker socket挂载（如果需要在Jenkins中使用Docker）
      # - /var/run/docker.sock:/var/run/docker.sock

      # 时区配置
      - /etc/localtime:/etc/localtime:ro

    # 环境变量
    environment:
      # JVM参数配置
      - JAVA_OPTS=-Duser.timezone=Asia/Shanghai -Xmx2g -Xms512m

      # Jenkins配置
      - JENKINS_OPTS=--prefix=/jenkins  # 如果需要配置URL前缀

      # 禁用安装向导（首次启动）
      # - JENKINS_INSTALL_RUN_SETUP_WIZARD=false

    # 资源限制（根据实际硬件调整）
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4'
    #       memory: 4G
    #     reservations:
    #       cpus: '2'
    #       memory: 2G

    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/login"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    # 网络配置
    networks:
      - jenkins-network

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

# 网络定义
networks:
  jenkins-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# 数据卷定义（如果使用命名卷）
# volumes:
#   jenkins_home:
#     driver: local
