pipeline {
    agent {
        label 'dotnet-test'  // 使用 dotnet-test 标签的 Agent
    }

    environment {
        // 项目配置
        PROJECT_NAME = 'DotNetSample'
        BUILD_CONFIGURATION = 'Release'

        // .NET 配置
        DOTNET_CLI_TELEMETRY_OPTOUT = '1'
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE = '1'
    }

    stages {
        stage('环境检查') {
            steps {
                echo '========== 环境信息 =========='
                sh 'dotnet --version'
                sh 'dotnet --list-sdks'
                sh 'git --version'
                sh 'echo "工作目录: $PWD"'
                sh 'echo "Jenkins 节点: $NODE_NAME"'
            }
        }

        stage('清理') {
            steps {
                echo '========== 清理旧的构建产物 =========='
                sh '''
                    if [ -d "bin" ]; then
                        rm -rf bin
                        echo "已删除 bin 目录"
                    fi
                    if [ -d "obj" ]; then
                        rm -rf obj
                        echo "已删除 obj 目录"
                    fi
                '''
            }
        }

        stage('还原依赖') {
            steps {
                echo '========== 还原 NuGet 包 =========='
                sh 'dotnet restore'
            }
        }

        stage('编译') {
            steps {
                echo '========== 编译项目 =========='
                sh """
                    dotnet build \
                        --configuration ${BUILD_CONFIGURATION} \
                        --no-restore \
                        -p:Version=${BUILD_NUMBER}
                """
            }
        }

        stage('发布') {
            steps {
                echo '========== 发布应用程序 =========='
                sh """
                    dotnet publish \
                        --configuration ${BUILD_CONFIGURATION} \
                        --no-build \
                        --output ./publish \
                        -p:Version=${BUILD_NUMBER}
                """
            }
        }

        stage('验证产物') {
            steps {
                echo '========== 验证发布产物 =========='
                sh '''
                    echo "发布目录内容:"
                    ls -lh ./publish

                    echo ""
                    echo "DLL 文件:"
                    find ./publish -name "*.dll" | head -10

                    echo ""
                    echo "主程序文件:"
                    if [ -f "./publish/DotNetSample.dll" ]; then
                        ls -lh ./publish/DotNetSample.dll
                        echo "✅ 主程序文件存在"
                    else
                        echo "❌ 主程序文件不存在"
                        exit 1
                    fi
                '''
            }
        }

        stage('归档产物') {
            steps {
                echo '========== 归档构建产物 =========='
                archiveArtifacts artifacts: 'publish/**/*', fingerprint: true
            }
        }
    }

    post {
        success {
            echo '=========================================='
            echo '✅ 构建成功！'
            echo '=========================================='
            echo "项目: ${PROJECT_NAME}"
            echo "配置: ${BUILD_CONFIGURATION}"
            echo "版本: ${BUILD_NUMBER}"
            echo "Agent: ${NODE_NAME}"
            echo '=========================================='
        }

        failure {
            echo '=========================================='
            echo '❌ 构建失败！'
            echo '=========================================='
            echo "项目: ${PROJECT_NAME}"
            echo "构建号: ${BUILD_NUMBER}"
            echo "Agent: ${NODE_NAME}"
            echo '=========================================='
        }

        always {
            echo '========== 清理工作空间 =========='
            // 可选：清理临时文件，保留 publish 目录
            sh '''
                if [ -d "obj" ]; then
                    rm -rf obj
                    echo "已清理 obj 目录"
                fi
            '''
        }
    }
}
